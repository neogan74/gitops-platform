apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: demo-app-go
spec:
  replicas: 2

  strategy:
    canary:
      # Reference to stable and canary services
      canaryService: demo-app-go-canary
      stableService: demo-app-go

      # Traffic routing (optional - for service mesh)
      # trafficRouting:
      #   istio:
      #     virtualService:
      #       name: demo-app-go
      #       routes:
      #       - primary

      # Canary deployment steps
      steps:
      # 1. Deploy canary with 20% traffic
      - setWeight: 20
      - pause: {duration: 1m}

      # 2. Run analysis
      - analysis:
          templates:
          - templateName: error-rate-only
          args:
          - name: service-name
            value: demo-app-go

      # 3. Increase to 40% if analysis passes
      - setWeight: 40
      - pause: {duration: 1m}

      # 4. Run comprehensive analysis
      - analysis:
          templates:
          - templateName: success-rate
          args:
          - name: service-name
            value: demo-app-go

      # 5. Increase to 60%
      - setWeight: 60
      - pause: {duration: 1m}

      # 6. Final analysis before full rollout
      - analysis:
          templates:
          - templateName: success-rate
          args:
          - name: service-name
            value: demo-app-go

      # 7. Promote to 100%
      - setWeight: 100

  template:
    spec:
      containers:
      - name: demo-app
        env:
        - name: VERSION
          value: "v1.0.0-staging"
        - name: ENVIRONMENT
          value: "staging"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 300m
            memory: 128Mi
